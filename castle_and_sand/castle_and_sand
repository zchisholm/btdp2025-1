// Castle and Sand
// Section 1

Employees
| count

// Q3
Employees
| where ip_addr == "10.10.2.1"
// Preston Lane - preston_lane@castleandsand.com - prlane - 6S7W-MACHINE

// Q4
Employees
| where name == "Jacqueline Henderson"
// jacqueline_henderson@castleandsand.com - 10.10.0.66 - 4UNT-DESKTOP

Email
| where recipient == "jacqueline_henderson@castleandsand.com"

// Q5
Email
| where sender has "sunandsandtrading.com"
| distinct sender
| count

// Q6
Employees
| where name == "Cristin Genao"
// 10.10.0.141 - cristin_genao@castleandsand.com - K7DG-LAPTOP

OutboundNetworkEvents
| where src_ip == "10.10.0.141"
| distinct url

// Q7
PassiveDns
| where domain contains "shark"
| distinct domain
// There is a diffreence between what t contains and has finds

//Q8
PassiveDns
| where domain contains "shark"

// Q9
let k_usernames =
Employees
| where name has "Karen"
| distinct ip_addr;
OutboundNetworkEvents
| where src_ip in (k_usernames)
| distinct url


// Section 2
// Q1
// sharknadorules_gang@onionmail.org 

// Q2
// SUNNYDAY123329JA0

// Q4 - Q5
FileCreationEvents
| where filename has "PAY_UP_OR_SWIM_WITH_THE_FISHES.txt"
| distinct hostname

// Q6 -Q8
let infected=
FileCreationEvents
| where filename has "PAY_UP_OR_SWIM_WITH_THE_FISHES.txt"
| distinct hostname;
Employees
| where hostname in (infected)
| where role has "IT" and ip_addr has ".46"
// Simeon Kakpovi - simeon_kakpovi@castleandsand.com - 10.10.0.46 - T6YP-MACHINE

let impact_hosts = FileCreationEvents
| where filename == 'PAY_UP_OR_SWIM_WITH_THE_FISHES.txt'
| distinct hostname;
SecurityAlerts
| where description has_any (impact_hosts)

// Q10 - Q11
let impact_hosts = FileCreationEvents
| where filename == 'PAY_UP_OR_SWIM_WITH_THE_FISHES.txt'
| distinct hostname;
let helpdesk_hostnames = Employees
| where hostname in (impact_hosts)
| where role contains "IT Helpdesk"
| distinct hostname;
SecurityAlerts
| where description has_any (helpdesk_hostnames)
// 6S7W-MACHINE

Employees
| where hostname == "6S7W-MACHINE"
// Preston Lane


// Q12 - Q14
FileCreationEvents
| where hostname == "6S7W-MACHINE" and filename == "Chomping-Schedule_Changes.xlsx"
// 2023-05-26T09:26:15Z

// Q15
FileCreationEvents
| where filename == "Chomping-Schedule_Changes.xlsx"
| distinct hostname

// Q16 - Q17
OutboundNetworkEvents
| where url has "Chomping-Schedule_Changes.xlsx"


// Q18
PassiveDns
| where domain == "jawfin.com"
| distinct ip

// Q19
// 193.248.75.126

// Q20
PassiveDns
| where domain == "sharkfin.com"
| distinct ip

// Q21 -Q22
let malicious_ips = 
PassiveDns
| where domain == "sharkfin.com" or domain == "jawfin.com"
| distinct ip;
InboundNetworkEvents
| where src_ip in (malicious_ips)

// Q23
let malicious_ips = 
PassiveDns
| where domain == "sharkfin.com" or domain == "jawfin.com"
| distinct ip;
AuthenticationEvents
| where src_ip in (malicious_ips)

// Q24
Email
| where link has "sharkfin.com" or link has "jawfin.com"

// Q25 - Q26
// 2023-05-25T16:33:09Z - legal.sand@verizon.com

// Q27
Email
| where sender == "legal.sand@verizon.com"

// Q28
let bad_emails =
Email
| where sender == "legal.sand@verizon.com"
| distinct reply_to;
Email
| where sender in (bad_emails) or recipient in (bad_emails) or reply_to in (bad_emails)

// Q29
let bad_emails =
Email
| where sender == "legal.sand@verizon.com"
| distinct reply_to;
Email
| where sender in (bad_emails) or recipient in (bad_emails) or reply_to in (bad_emails)
| distinct link

// Q30
let bad_emails =
Email
| where sender == "legal.sand@verizon.com"
| distinct reply_to;
let urls =
Email
| where sender in (bad_emails) or recipient in (bad_emails) or reply_to in (bad_emails)
| distinct link;
let domains = 
urls
| extend Host = tostring(parse_url(link).Host) 
| distinct Host;
let bad_ips =
PassiveDns
| where domain in (domains)
| distinct ip;
// Q31
AuthenticationEvents
| where src_ip in (bad_ips)

// Q32
// Unique file names
let bad_emails =
Email
| where sender == "legal.sand@verizon.com"
| distinct reply_to;
Email
| where sender in (bad_emails) or recipient in (bad_emails) or reply_to in (bad_emails)
| distinct link

// Q33 - Q34
let bad_emails =
Email
| where sender == "legal.sand@verizon.com"

// Somehow lost all my work up to section 3 quesion 11

// all I could save... smh
let bad_emails = 
Email
| where sender == "legal.sand@verizon.com"
| distinct reply_to;

let urls = 
Email
| where sender in (bad_emails) or recipient in (bad_emails) or reply_to in (bad_emails)
| distinct link;

let domains = 
urls
| extend Host = parse_url(link).Host
| distinct Host;



let bad_emails =
Email
| where sender == "legal.sand@verizon.com"
| distinct reply_to;
let urls =
Email
| where sender in (bad_emails) or recipient in (bad_emails) or reply_to in (bad_emails)
| distinct link;
let domains = 
urls
| extend Host = parse_url(link).Host
| distinct Host;
PassiveDns
| where domain in (domains)


// Q45
